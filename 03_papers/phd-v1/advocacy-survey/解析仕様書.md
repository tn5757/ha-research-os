# 解析仕様書（拡張版：回帰分析・効果推定・因果解釈を含む／日本語）

## 研究題目

日本の小児科専門研修プログラムにおけるHealth Advocacy（HA）教育の実施状況と規定因子：全国調査（横断研究）

## 研究目的（RQ対応）

- **RQ1**：HA教育の実施率（有無）を推定する
- **RQ2**：教育内容・形式（opportunistic／formal、micro/meso/macro）を記述し、関連要因を検討する
- **RQ3**：障壁（faculty expertise不足等）の分布と、実装・形式・内容との関連を検討する

### 追加目的（効果推定/因果）

- 「HA教育の実装（有）」が「マクロレベル教育の導入」や「形式のフォーマル化（定義・教材の整備）」に与える効果
- 「faculty expertise不足」が「HA教育の実装（有）」に与える効果

を、因果仮説に基づき推定する（横断研究の制約を明示）

---

## 1. データ

| 項目 | 内容 |
|------|------|
| 対象 | 189プログラム中、回答プログラム（想定84、2025/12/31時点） |
| データ | `survey.xlsx` |
| 主データ | `1;id` 〜 `q21` |
| データ辞書 | ラベル対応表 |
| 単位 | 1プログラム = 1観測 |

---

## 2. 主要変数定義（辞書で列を確定し、コード→ラベル化）

### 2.1 アウトカム（Y）

| 変数 | 型 | 定義 |
|------|------|------|
| **Y1** | binary | HA教育実装：「HA教育を実施しているか」該当設問を二値化（Yes=1 / No=0） |
| **Y2** | binary | マクロレベル教育の有無：「政策/立法/制度等（macro）を扱う」該当設問（あり=1 / なし=0） |
| **Y3** | binary/ordinal | 形式のフォーマル化 |

Y3 の例：

- HAの定義明示（あり/なし）
- 教材使用（あり/なし）
- 構造化教育の有無（formal vs opportunistic）
- 必要に応じて「フォーマル化スコア」（0–k）も作成

### 2.2 介入・曝露（T）

因果推定の"介入"として以下を想定（複数モデルで実施）：

| 変数 | 内容 |
|------|------|
| **T1** | HA教育実装（Y1）→ Y2/Y3 への効果 |
| **T2** | faculty expertise不足（barrier）→ Y1 への効果 |
| **T3** | 時間不足/カリキュラム余地なし/評価法不明（barrier群）→ Y1 への効果 |

### 2.3 共変量（X：交絡候補）

データに存在する範囲で、以下を候補に設定（辞書から該当列を抽出して確定）：

- **回答者属性**：役割（PD/教育担当等）、経験年数
- **プログラム特性**：規模、基幹/連携、地域、教育リソース（教育担当配置など）
- **既存の教育文化・体制**：構造化カリキュラムの有無、評価制度の有無

> ※列が無い場合は「交絡調整不能」として限界を明記し、感度分析で補う

---

## 3. 前処理

1. ラベル対応表に基づき、各列の質問文・選択肢・SA/MAを付与
2. MA（複数選択）は 0/1 ダミーへ整形
3. 欠損統一（空白、NA等 → `NaN`）
4. 解析用データ保存：`output/clean.csv` / `output/clean.parquet`
5. 変数辞書出力：`output/data_dictionary.csv`（列名・質問文・型・ラベル）

---

## 4. 記述統計（RQ1–RQ3）

- 回答率、N
- **RQ1**：Y1（実装率）点推定 ＋ 95%CI（Wilson推奨）
- **RQ2**：形式（opportunistic/formal、定義・教材）、内容（micro/meso/macro）の割合 ＋ 95%CI
- **RQ3**：障壁（faculty expertise不足等）の割合 ＋ 95%CI

> 主要結果を抄録値（例：57.1%、91.5%、95.8%、4.2%、33.3%、29.2%、81.0%）と一致するよう再現

---

## 5. 回帰分析（関連推定：association）

### 5.1 実装（Y1）を目的変数としたロジスティック回帰

- **モデル**：`logit(P(Y1=1)) = β0 + β1*barrier + β2*X + …`
- **出力**：OR、95%CI、p値、擬似R²、校正（calibration）指標
- **変数選択**：
  - 理論（DAG）優先の事前指定
  - 追加は過学習回避（events per variable に配慮、必要なら LASSO 補助）

### 5.2 マクロ導入（Y2）／フォーマル化（Y3）モデル

- **Y2**（二値）：ロジスティック回帰
- **Y3**（スコア化した場合）：順序ロジスティック or Poisson/負の二項（分布により）

### 5.3 多重比較

- 探索的に多数の設問を比較する場合は **FDR（Benjamini–Hochberg）** を併記

---

## 6. 効果推定・因果解釈（causal inference）

横断研究であることを踏まえ、因果仮説を明確化し、推定対象（estimand）を定義して解析する。

### 6.1 因果仮説と推定対象（Estimands）

| Estimand | 定義 | 例 |
|----------|------|------|
| **E1：ATE** | 平均処置効果 | T1=HA教育実装（1 vs 0）が Y2=マクロ導入に与える効果 |
| **E2：ATT** | 処置群平均効果 | 実装しているプログラムにおける、もし実装していなかった場合との差 |
| **E3** | 障壁の効果 | T2=faculty expertise不足（1 vs 0）が Y1 に与える効果 |

### 6.2 因果同定の前提（明示）

1. **交換可能性**（未測定交絡が無い）
2. **適切な時間順序**（横断のため脆弱：障壁⇄実装の同時性を議論）
3. **陽性**（positivity）
4. **一貫性**（consistency）

> ※時間順序が曖昧なものは、主解析では「関連」、副解析で「因果仮説としての推定」として位置づけ、解釈を限定する。

### 6.3 DAG（概念モデル）

- ノード例：`プログラム資源/規模 → (faculty expertise, 時間) → 実装 → (フォーマル化、マクロ導入)`
- DAGに基づき**最小調整集合（minimal adjustment set）**を決定
- データに存在しない交絡は「未調整」と明記

### 6.4 推定手法（複数法で頑健性確認）

#### (A) 逆確率重み付け（IPW）／傾向スコア（PS）

- PSモデル：`P(T=1|X)` をロジスティックで推定
- 重み：ATE/ATT を目的に選択、安定化重み使用
- バランス評価：SMD（標準化差）< 0.1 を目標
- 効果：リスク差（RD）/ リスク比（RR）/ オッズ比（OR）いずれか（原則RDも併記）

#### (B) Doubly Robust（AIPW / TMLE相当の二重頑健）

- アウトカムモデル ＋ PSモデルの二重化で推定
- サンプルが小さいため過適合回避（単純モデル ＋ 正則化を検討）

#### (C) 回帰標準化（G-computation）

- 調整後予測値から ATE を計算（解釈しやすい）

### 6.5 感度分析（因果の限界を補強）

- **未測定交絡に対する感度**：E-value（ORベース）等
- **逆因果の可能性**：
  - 障壁（faculty expertise不足）が「実装の結果として認知されている」可能性を議論
  - 「構造化要素（定義・教材）」を媒介としたモデル（媒介分析は探索的扱い）

---

## 7. 欠損の扱い

| 解析 | 方法 |
|------|------|
| **主解析** | complete-case（設問ごとの有効Nを明記） |
| **追加解析** | 多重代入（MICE）を実施し、主要推定（OR/ATE）が大きく変わらないか確認 |

- 代入モデルにアウトカム・曝露・共変量を含める
- 代入回数：m=20 程度（実装は Claude Code で可変）

---

## 8. 出力物（論文・学会両対応）

| ファイル | 内容 |
|----------|------|
| `output/summary_RQ1-3.md` | 抄録に対応する表現 |
| `output/table_RQ1_impl.csv` | 実装率 ＋ CI |
| `output/table_RQ2_content_format.csv` | 教育内容・形式 |
| `output/table_RQ3_barriers.csv` | 障壁分布 |
| `output/regression_Y1.csv` | OR, CI, p |
| `output/causal_effects.csv` | ATE/ATT, RD/RR/OR, CI |
| 図用データ | 棒グラフ（micro/meso/macro）、障壁ランキング等（PNG/CSV） |

---

## 9. 実装要件（Claude Code向け）

| スクリプト | 役割 |
|------------|------|
| `src/01_build_dictionary.py` | 辞書読込・型推定・ラベル付与 |
| `src/02_cleaning.py` | データクリーニング |
| `src/03_descriptive.py` | RQ1–3の再現 |
| `src/04_regression.py` | 回帰分析 |
| `src/05_causal.py` | PS/IPW/AIPW/G-computation、バランス評価、感度分析 |
| `src/run_analysis.py` | 全工程実行 |

依存管理：`requirements.txt` / `README.md`
